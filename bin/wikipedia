#! /usr/bin/env ruby

require 'wikipedia'

def article_filename(title)
  title + ".wiki"
end

cookie_file_name = ".wikipedia_cookie"

argv = ARGV;
cmd = argv.shift

cl = MediawikiApi::Client.new(Wikipedia::API_URL)
begin
  File.open(cookie_file_name, "r", 0600) do |cookie_file|
    cl.load_cookie(cookie_file)
  end
rescue Errno::ENOENT
end


case cmd
when "login"
  username = argv.shift ||
    begin
      puts "Username:"
      gets
    end
  puts "Password:"
  begin
    system "stty -echo"
    password = gets or abort
    password.chomp!
  ensure
    system "stty echo"
  end
  cl.log_in(username, password)

when "checkout"
  title = argv.shift or abort "Need title"
  reply = cl.get_wikitext(title) or abort "failed to retrieve"
  reply.success? or abort "failed to retrieve"
  File.open(article_filename(title), "w") do |file|
    file.write(reply.body)
  end

when "log"
  title = argv.shift or abort "Need title"
  reply = cl.prop("revisions", {rvlimit: 50, continue: "", rvprop: "ids"})
  reply.success? or abort "failed to retrieve"
  p reply
  p reply.data
else
  abort "Unknown command"
end

File.open(cookie_file_name, "w", 0600) do |cookie_file|
  cl.save_cookie(cookie_file)
end
